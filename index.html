<!DOCTYPE html><html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mes Adresses sur une Carte</title>
    <!-- Inclure la bibliothèque Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Style pour la carte */
        #map {
            height: 600px;
            width: 100%;
        }
        /* Style pour le tableau */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>volks.eco</h1>
    <!-- Conteneur pour la carte -->
    <div id="map"></div>
    <!-- Tableau pour afficher les adresses -->
    <table id="addressTable">
        <thead>
            <tr>
                <th>Ville</th>
                <th>Pays</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="addressTableBody"></tbody>
    </table>
    <!-- Bouton pour télécharger le JSON -->
    <button onclick="downloadJSON()">Télécharger adresses.json</button>

<!-- Inclure la bibliothèque Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Initialiser la carte avec une vue globale (zoom niveau 2 pour voir le monde entier)
    var map = L.map('map').setView([0, 0], 2);

    // Ajouter une couche OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Tableau pour stocker les adresses
    let addresses = [];
    let markers = [];

    // Charger les adresses depuis localStorage si disponibles, sinon depuis le fichier JSON
    const storedAddresses = localStorage.getItem('addresses');
    if (storedAddresses) {
        addresses = JSON.parse(storedAddresses);
        updateMapAndTable();
    } else {
        // Charger le fichier JSON initial
        fetch('adresses.json')
            .then(response => response.json())
            .then(data => {
                addresses = data;
                saveToLocalStorage(); // Sauvegarder initialement dans localStorage
                updateMapAndTable();
            })
            .catch(error => console.error('Erreur lors du chargement du JSON:', error));
    }

    // Fonction pour sauvegarder les adresses dans localStorage
    function saveToLocalStorage() {
        localStorage.setItem('addresses', JSON.stringify(addresses));
    }

    // Fonction pour effectuer un géocodage inverse avec Nominatim
    async function reverseGeocode(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            return {
                address: data.display_name || 'Adresse non disponible',
                city: data.address.city || data.address.town || data.address.village || 'Inconnu',
                country: data.address.country || 'Inconnu'
            };
        } catch (error) {
            console.error('Erreur lors du géocodage inverse:', error);
            return { address: 'Adresse non disponible', city: 'Inconnu', country: 'Inconnu' };
        }
    }

    // Fonction pour mettre à jour la carte et le tableau
    function updateMapAndTable() {
        // Supprimer les anciens marqueurs
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Ajouter les nouveaux marqueurs
        addresses.forEach((location, index) => {
            if (location.latitude && location.longitude) {
                const marker = L.marker([location.latitude, location.longitude])
                    .addTo(map)
                    .bindPopup(`<b>${location.name}</b>
${location.address || 'Adresse non précisée'}`);
                markers.push(marker);

                // Ajouter un événement pour modifier au clic sur le marqueur
                marker.on('click', () => {
                    const newName = prompt('Modifier le nom:', location.name);
                    const newAddress = prompt('Modifier l\'adresse:', location.address);
                    if (newName) location.name = newName;
                    if (newAddress) location.address = newAddress;
                    saveToLocalStorage(); // Sauvegarder après modification
                    updateMapAndTable();
                });
            }
        });

        // Mettre à jour le tableau
        const tableBody = document.getElementById('addressTableBody');
        tableBody.innerHTML = '';
        addresses.forEach((location, index) => {
            const row = document.createElement('tr');
            // Extraire ville et pays depuis l'adresse (approximation simple)
            const parts = location.address ? location.address.split(',') : ['Inconnu', 'Inconnu'];
            const city = parts[parts.length - 3] || parts[parts.length - 2] || 'Inconnu';
            const country = parts[parts.length - 1] || 'Inconnu';
            row.innerHTML = `
                <td>${city.trim()}</td>
                <td>${country.trim()}</td>
                <td>${location.latitude.toFixed(6)}</td>
                <td>${location.longitude.toFixed(6)}</td>
                <td><button onclick="deleteAddress(${index})">Supprimer</button></td>
            `;
            tableBody.appendChild(row);
        });
    }
        // Ajouter une adresse en cliquant sur la carte
        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;
            // Générer un nom automatique avec les coordonnées
            const name = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
            // Effectuer un géocodage inverse pour obtenir l'adresse, ville et pays
            const geoData = await reverseGeocode(lat, lng);
            addresses.push({
                name: name,
                address: geoData.address,
                latitude: lat,
                longitude: lng,
                city: geoData.city,    // Ajout pour le tableau
                country: geoData.country // Ajout pour le tableau
            });
            saveToLocalStorage(); // Sauvegarder après ajout
            updateMapAndTable();
        });

    // Supprimer une adresse
    function deleteAddress(index) {
        if (confirm('Voulez-vous supprimer cette adresse ?')) {
            addresses.splice(index, 1);
            saveToLocalStorage(); // Sauvegarder après suppression
            updateMapAndTable();
        }
    }

    // Télécharger le JSON modifié
    function downloadJSON() {
        const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(addresses, null, 2));
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute('href', dataStr);
        downloadAnchor.setAttribute('download', 'adresses.json');
        document.body.appendChild(downloadAnchor);
        downloadAnchor.click();
        document.body.removeChild(downloadAnchor);
    }
</script></body>
</html>

